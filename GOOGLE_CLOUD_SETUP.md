# Google Cloud Setup Guide

## Project Information
- **Project ID**: `projectsso-473108`
- **Region**: `us-central1`
- **Bucket Name**: `projectsso-pitch-decks`

## Prerequisites

### 1. Install Google Cloud CLI
Download and install from: https://cloud.google.com/sdk/docs/install

For Windows, download the installer and run:
```powershell
(New-Object Net.WebClient).DownloadFile("https://dl.google.com/dl/cloudsdk/channels/rapid/GoogleCloudSDKInstaller.exe", "$env:Temp\GoogleCloudSDKInstaller.exe")
& $env:Temp\GoogleCloudSDKInstaller.exe
```

### 2. Authenticate with Google Cloud
```powershell
gcloud auth login
gcloud auth application-default login
```

### 3. Verify APIs are enabled
```powershell
gcloud services list --enabled --project=projectsso-473108
```

You should see:
- ✅ storage-api.googleapis.com
- ✅ sqladmin.googleapis.com
- ✅ run.googleapis.com
- ✅ cloudbuild.googleapis.com
- ✅ secretmanager.googleapis.com

## Quick Setup (Automated)

Run the automated setup script:
```powershell
cd "d:\TeamSSO 2025\Team-SSO"
.\setup-gcloud.ps1
```

This will:
1. ✅ Create Cloud Storage bucket
2. ✅ Configure bucket lifecycle policies
3. ✅ Create service account with proper permissions
4. ✅ Create Cloud SQL PostgreSQL instance (5-10 minutes)
5. ✅ Create database
6. ✅ Store secrets in Secret Manager
7. ✅ Generate local `.env` file
8. ✅ Generate service account key

## Manual Setup (Step-by-Step)

If you prefer manual setup or need to troubleshoot:

### Step 1: Set Active Project
```powershell
gcloud config set project projectsso-473108
```

### Step 2: Create Cloud Storage Bucket
```powershell
gcloud storage buckets create gs://projectsso-pitch-decks `
    --location=us-central1 `
    --uniform-bucket-level-access `
    --public-access-prevention
```

### Step 3: Create Service Account
```powershell
gcloud iam service-accounts create team-SSO-backend-sa `
    --display-name="Team-SSO Backend Service Account"
```

### Step 4: Grant Permissions
```powershell
# Storage permissions
gcloud storage buckets add-iam-policy-binding gs://projectsso-pitch-decks `
    --member="serviceAccount:team-SSO-backend-sa@projectsso-473108.iam.gserviceaccount.com" `
    --role="roles/storage.objectAdmin"

# Cloud SQL client
gcloud projects add-iam-policy-binding projectsso-473108 `
    --member="serviceAccount:team-SSO-backend-sa@projectsso-473108.iam.gserviceaccount.com" `
    --role="roles/cloudsql.client"

# Secret Manager
gcloud projects add-iam-policy-binding projectsso-473108 `
    --member="serviceAccount:team-SSO-backend-sa@projectsso-473108.iam.gserviceaccount.com" `
    --role="roles/secretmanager.secretAccessor"
```

### Step 5: Create Cloud SQL Instance
```powershell
gcloud sql instances create team-SSO-db `
    --database-version=POSTGRES_15 `
    --tier=db-f1-micro `
    --region=us-central1 `
    --root-password=YOUR_SECURE_PASSWORD `
    --storage-type=SSD `
    --storage-size=10GB
```

### Step 6: Create Database
```powershell
gcloud sql databases create team_SSO_db --instance=team-SSO-db
```

## Database Migration

### Option 1: Using Cloud SQL Proxy (Recommended for local dev)

1. **Install Cloud SQL Proxy**:
```powershell
# Download
Invoke-WebRequest -Uri "https://dl.google.com/cloudsql/cloud_sql_proxy_x64.exe" -OutFile "cloud_sql_proxy.exe"

# Run proxy
.\cloud_sql_proxy.exe --instances=projectsso-473108:us-central1:team-SSO-db=tcp:5432
```

2. **In a new terminal, run migrations**:
```powershell
cd server
$env:PGPASSWORD="YOUR_PASSWORD"
psql -h 127.0.0.1 -U postgres -d team_SSO_db -f schema.sql
```

### Option 2: Using gcloud CLI
```powershell
cd server
gcloud sql connect team-SSO-db --user=postgres --quiet < schema.sql
```

## Local Development Setup

### 1. Install Dependencies
```powershell
cd server
npm install
```

### 2. Configure Environment
Edit `server/.env` with your credentials (generated by setup script)

### 3. Start Development Server
```powershell
npm run dev
```

Server should start at: http://localhost:3000

## Testing the Backend

### Test Health Check
```powershell
curl http://localhost:3000/health
```

Expected response:
```json
{
  "status": "ok",
  "timestamp": "2025-10-18T..."
}
```

### Test Database Connection
```powershell
curl http://localhost:3000/api/companies
```

Should return sample companies array.

## Deployment to Cloud Run

### 1. Create Dockerfile
Already created in `server/Dockerfile`

### 2. Build Container Image
```powershell
cd server
gcloud builds submit --tag gcr.io/projectsso-473108/team-SSO-backend
```

### 3. Deploy to Cloud Run
```powershell
gcloud run deploy team-SSO-backend `
    --image gcr.io/projectsso-473108/team-SSO-backend `
    --platform managed `
    --region us-central1 `
    --allow-unauthenticated `
    --service-account team-SSO-backend-sa@projectsso-473108.iam.gserviceaccount.com `
    --add-cloudsql-instances projectsso-473108:us-central1:team-SSO-db `
    --set-env-vars "NODE_ENV=production" `
    --set-secrets "DATABASE_URL=DATABASE_URL:latest,JWT_SECRET=JWT_SECRET:latest,STORAGE_BUCKET=STORAGE_BUCKET:latest"
```

### 4. Get Cloud Run URL
```powershell
gcloud run services describe team-SSO-backend --region us-central1 --format "value(status.url)"
```

### 5. Update Frontend
Update `src/config.ts` with the Cloud Run URL:
```typescript
export const API_BASE_URL = process.env.NODE_ENV === 'production'
  ? 'https://team-SSO-backend-[hash].run.app'
  : 'http://localhost:3000';
```

## Cost Optimization Tips

### Current Configuration (Budget-Friendly)
- **Cloud SQL**: db-f1-micro ($7-10/month)
- **Cloud Storage**: ~$1-2/month (first GB free)
- **Cloud Run**: Pay-per-use (~$5-10/month for MVP traffic)
- **Total**: ~$15-25/month

### Your Credits
- **Available**: $500
- **Expected Duration**: 20+ months at MVP scale
- **Break-even**: ~16-20 months

### Reduce Costs Further
1. **Enable Cloud SQL automatic backup retention**: 7 days instead of 30
2. **Use Cloud Storage lifecycle policies**: Auto-delete old files
3. **Set Cloud Run concurrency**: 80 (default) to maximize efficiency
4. **Enable Cloud Run minimum instances**: 0 (scale to zero when idle)

## Monitoring & Logs

### View Cloud Run Logs
```powershell
gcloud run services logs read team-SSO-backend --region=us-central1
```

### View Cloud SQL Logs
```powershell
gcloud sql operations list --instance=team-SSO-db
```

### View Storage Usage
```powershell
gcloud storage du -s gs://projectsso-pitch-decks
```

## Troubleshooting

### Issue: Cloud SQL connection timeout
**Solution**: Ensure Cloud SQL Proxy is running or Cloud Run has proper IAM permissions

### Issue: Storage upload fails
**Solution**: Check service account has `roles/storage.objectAdmin` on the bucket

### Issue: Secrets not accessible
**Solution**: Verify service account has `roles/secretmanager.secretAccessor`

### Issue: High costs
**Solution**: Check Cloud Run is scaling to zero when idle:
```powershell
gcloud run services describe team-SSO-backend --region=us-central1 --format="value(spec.template.spec.containerConcurrency)"
```

## Security Checklist

- ✅ Service account key is in `.gitignore`
- ✅ Database password is stored in Secret Manager
- ✅ JWT secret is stored in Secret Manager
- ✅ Cloud Storage bucket has uniform access control
- ✅ Cloud SQL allows only Cloud Run connections
- ✅ Environment variables are not committed to Git
- ✅ CORS is configured to only allow your frontend domain

## Next Steps

1. ✅ Run `setup-gcloud.ps1` to automate infrastructure setup
2. ⏳ Wait 5-10 minutes for Cloud SQL instance creation
3. ⏳ Run database migrations with `schema.sql`
4. ⏳ Test backend locally with Cloud SQL Proxy
5. ⏳ Deploy to Cloud Run
6. ⏳ Update frontend with Cloud Run URL
7. ⏳ Test end-to-end integration

## Support Resources

- [Cloud SQL Documentation](https://cloud.google.com/sql/docs)
- [Cloud Run Documentation](https://cloud.google.com/run/docs)
- [Cloud Storage Documentation](https://cloud.google.com/storage/docs)
- [Google Cloud Pricing Calculator](https://cloud.google.com/products/calculator)
